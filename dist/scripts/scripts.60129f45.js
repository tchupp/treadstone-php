"use strict";angular.module("treadstoneApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","LocalStorageModule"]).run(["$rootScope","$window","Principal","Auth","Router",function(a,b,c,d,e){a.$on("$routeChangeStart",function(b,c){a.nextRouteName=c.$$route.originalPath,a.nextRouteData=c.$$route.data,a.nextRouteParams=c.params,d.authorize()}),a.$on("$routeChangeSuccess",function(d,e,f){var g="TreadCourse-Dev";c.isAuthenticated()&&a.previousRouteName&&(a.previousRouteName=f.$$route.originalPath,a.previousRouteData=f.$$route.data,a.previousRouteParams=f.params);var h=e.$$route;h.data&&h.data.pageTitle&&(g=h.data.pageTitle+" | "+g),b.document.title=g}),a.back=function(){a.previousRouteName&&"/activate"!==a.previousRouteName&&null!==a.previousRouteName?e.toPrevious():e.toDashboard()}}]).config(["$routeProvider","$httpProvider",function(a,b){a.otherwise({redirectTo:"/landing"}),b.interceptors.push("ErrorInterceptor"),b.interceptors.push("AuthExpiredInterceptor"),b.interceptors.push("AuthInterceptor")}]),angular.module("treadstoneApp").controller("AboutController",["$scope","Features",function(a,b){function c(a){return{status:a,statusText:"Internal Server Error",description:"No details available"}}a.awesomeThings=[],a.loading=!0,b.query(function(d){a.loading=!1,a.awesomeThings=d,a.awesomeThings.forEach(function(a){a.loading=!0,b.get({id:a.id},function(b){a.loading=!1,a.description=b.description},function(b,d){a.loading=!1,a.error=b&&b.description?b:c(d)})})},function(b,d){a.loading=!1,a.error=b&&b.description?b:c(d)})}]),angular.module("treadstoneApp").config(["$routeProvider",function(a){a.when("/about",{templateUrl:"scripts/app/about/about.html",controller:"AboutController",data:{roles:["ROLE_DEV"],pageTitle:"About"}})}]),angular.module("treadstoneApp").controller("ActivationController",["$scope","$routeParams","Auth",function(a,b,c){c.activateAccount({key:b.key}).then(function(){a.error=!1,a.success=!0})["catch"](function(){a.success=!1,a.error=!0})}]),angular.module("treadstoneApp").config(["$routeProvider",function(a){a.when("/activate",{templateUrl:"scripts/app/account/activate/activate.html",controller:"ActivationController",data:{roles:[],pageTitle:"Activate"}})}]),angular.module("treadstoneApp").controller("RegisterController",["$scope","Auth",function(a,b){a.registerAccount={},a.success=!1,a.errorUserExists=!1,a.errorEmailExists=!1,a.doNotMatch=!1,a.register=function(){a.registerAccount.password!==a.confirmPassword?a.doNotMatch=!0:(a.errorUserExists=!1,a.errorEmailExists=!1,a.doNotMatch=!1,b.createAccount(a.registerAccount).then(function(){a.success=!0})["catch"](function(b){a.success=!1,400===b.status&&"Login already in use"===b.data.description?a.errorUserExists=!0:400===b.status&&"E-mail address already in use"===b.data.description&&(a.errorEmailExists=!0)}))}}]),angular.module("treadstoneApp").config(["$routeProvider",function(a){a.when("/register",{templateUrl:"scripts/app/account/register/register.html",controller:"RegisterController",data:{roles:[],pageTitle:"Register"}})}]),angular.module("treadstoneApp").controller("CoursesController",["$scope","Semester","Subject","Section",function(a,b,c,d){function e(){b.query(function(b){a.loading=!1,a.semesters=b},function(){a.loading=!1})}a.selectedSchool="Michigan State University",a.selectedSemester=null,a.selectedSubject=null,a.selectedSection=null,a.semesters=[],a.subjects=[],a.sections=[],a.loading=!0,e(),a.clearSemester=function(){a.selectedSemester=null,a.subjects=[],a.selectedSection=null,a.selectedSubject=null,a.sections=[]},a.clearSubject=function(){a.selectedSection=null,a.selectedSubject=null,a.sections=[]},a.clearSection=function(){a.selectedSection=null},a.selectSemester=function(b){a.clearSemester(),a.selectedSemester=b.code,c.query({semester:a.selectedSemester},function(b){a.loading=!1,a.subjects=b},function(){a.loading=!1})},a.selectSubject=function(b){a.selectedSubject=null,a.selectedSection=null,a.selectedSubject=b.subjectCode,d.query({semester:a.selectedSemester,subject:a.selectedSubject},function(b){a.loading=!1,a.sections=b},function(){a.loading=!1})},a.selectSection=function(b){a.selectedSection=null,a.selectedSection=b}}]),angular.module("treadstoneApp").config(["$routeProvider",function(a){var b={templateUrl:"scripts/app/courses/courses.html",controller:"CoursesController",data:{roles:["ROLE_USER"],pageTitle:"Courses"}};a.when("/courses",b)}]),angular.module("treadstoneApp").controller("DashboardController",function(){}),angular.module("treadstoneApp").config(["$routeProvider",function(a){a.when("/dashboard",{templateUrl:"scripts/app/dashboard/dashboard.html",controller:"DashboardController",data:{roles:["ROLE_USER"],pageTitle:"Dashboard"}})}]),angular.module("treadstoneApp").controller("DocsController",["$scope","Docs",function(a,b){function c(){b.query(function(b){a.loading=!1,a.docs=b},function(){a.loading=!1})}a.docs=[],a.loading=!0,c()}]),angular.module("treadstoneApp").config(["$routeProvider",function(a){a.when("/docs",{templateUrl:"scripts/app/docs/docs.html",controller:"DocsController",data:{roles:["ROLE_DEV"],pageTitle:"Docs"}})}]),angular.module("treadstoneApp").config(["$routeProvider",function(a){a.when("/accessdenied",{templateUrl:"scripts/app/error/accessdenied.html",data:{roles:[],pageTitle:"Access Denied"}})}]),angular.module("treadstoneApp").controller("LandingController",["$rootScope","$scope","Auth","Router",function(a,b,c,d){b.submitLogin=function(){c.login({login:b.login,password:b.password}).then(function(){b.authenticationError=!1,"/register"===a.previousRouteName?d.toDashboard():a.back()})["catch"](function(){b.authenticationError=!0})}}]),angular.module("treadstoneApp").config(["$routeProvider",function(a){a.when("/landing",{templateUrl:"scripts/app/landing/landing.html",controller:"LandingController",data:{roles:[],pageTitle:"Landing"}})}]),angular.module("treadstoneApp").directive("tsAlertToast",["$rootScope","AlertService",function(a,b){return{restrict:"E",templateUrl:"scripts/components/alert/alert.toast.html",controller:["$scope",function(c){c.alerts=b.get(),a.$on("treadstoneApp.httpError",function(a,b){d(b.data.description)}),c.$on("$destroy",function(){});var d=function(a){b.error(a)}}]}}]),angular.module("treadstoneApp").factory("AlertService",["$timeout",function(a){function b(a){return m.splice(a,1)}function c(a){return b(m.indexOf(a))}function d(){m=[]}function e(){return m}function f(b){b.alertId=l++,b.timeout=n,g(b),a(function(){c(b.alertId)},b.timeout)}function g(a){return m.push({type:a.type,msg:a.msg,id:a.alertId,timeout:a.timeout,close:function(){return o.closeAlert(this)}})}function h(a){f({type:"success",msg:a})}function i(a){f({type:"danger",msg:a})}function j(a){f({type:"warning",msg:a})}function k(a){f({type:"info",msg:a})}var l=0,m=[],n=1e4,o={clear:d,get:e,success:h,error:i,warning:j,info:k,add:f,factory:g,closeAlert:c,closeAlertByIndex:b};return o}]),angular.module("treadstoneApp").factory("ErrorInterceptor",["$q","$rootScope",function(a,b){return{responseError:function(c){return(401!==c.status||0!==c.data.path.indexOf("/account"))&&b.$emit("treadstoneApp.httpError",c),a.reject(c)}}}]),angular.module("treadstoneApp").factory("AuthInterceptor",["$injector",function(a){return{request:function(b){b.headers=b.headers||{};var c=a.get("AuthServerProvider");return c.hasValidToken()&&(b.headers["x-auth-token"]=c.getToken().authToken),b}}}]).factory("AuthExpiredInterceptor",["$injector","$q",function(a,b){return{responseError:function(c){if(401===c.status&&("Authentication Failed"===c.data.description||"Authentication Missing"===c.data.description)){var d=a.get("AuthServerProvider");d.logout();var e=a.get("Principal");if(e.isIdentityResolved()){var f=a.get("Auth");f.authorize(!0)}}return b.reject(c)}}}]),angular.module("treadstoneApp").factory("Auth",["$rootScope","$q","Principal","Account","Register","Activate","AuthServerProvider","Password","PasswordResetInit","PasswordResetFinish","Router",function(a,b,c,d,e,f,g,h,i,j,k){return{login:function(a,d){var e=d||angular.noop,f=b.defer();return g.login(a).then(function(a){return c.identity(!0).then(function(){f.resolve(a)}),e()})["catch"](function(a){return this.logout(),f.reject(a),e(a)}.bind(this)),f.promise},logout:function(){g.logout(),c.authenticate(null)},authorize:function(b){return c.identity(b).then(function(){var b=c.isAuthenticated(),d="/register"===a.nextRouteName,e="/activate"===a.nextRouteName,f="/landing"===a.nextRouteName;b&&(d||e||f)&&k.toDashboard();var g=a.nextRouteData;g&&g.roles&&g.roles.length>0&&!c.hasAnyAuthority(g.roles)&&(b?k.toAccessDenied():(a.previousRouteName=a.nextRouteName,a.previousRouteData=a.nextRouteData,a.previousRouteParams=a.nextRouteParams,k.toLanding()))})},createAccount:function(a,b){var c=b||angular.noop;return e.save(a,function(){return c(a)},function(a){return this.logout(),c(a)}.bind(this)).$promise},updateAccount:function(a,b){var c=b||angular.noop;return d.save(a,function(){return c(a)},function(a){return c(a)}.bind(this)).$promise},activateAccount:function(a,b){var c=b||angular.noop;return f.get(a,function(a){return c(a)},function(a){return c(a)}.bind(this)).$promise},changePassword:function(a,b){var c=b||angular.noop;return h.save(a,function(){return c()},function(a){return c(a)}).$promise},resetPasswordInit:function(a,b){var c=b||angular.noop;return i.save(a,function(){return c()},function(a){return c(a)}).$promise},resetPasswordFinish:function(a,b){var c=b||angular.noop;return j.save(a,function(){return c()},function(a){return c(a)}).$promise}}}]),angular.module("treadstoneApp").directive("hasAuthority",["Principal",function(a){return{restrict:"A",link:function(b,c,d){var e=function(){c.removeClass("hidden")},f=function(){c.addClass("hidden")},g=function(b){b&&e(),a.hasAuthority(h)?e():f()},h=d.hasAuthority.replace(/\s+/g,"");h.length>0&&g(!0)}}}]),angular.module("treadstoneApp").factory("Principal",["$q","Account",function(a,b){var c,d=!1;return{isIdentityResolved:function(){return angular.isDefined(c)},isAuthenticated:function(){return d},hasAuthority:function(a){return d&&c&&c.role?c.role&&-1!==c.role.indexOf(a):!1},hasAnyAuthority:function(a){if(!d||!c||!c.role)return!1;for(var b=0;b<a.length;b++)if(-1!==c.role.indexOf(a[b]))return!0;return!1},authenticate:function(a){c=a,d=null!==a},identity:function(e){var f=a.defer();return e===!0&&(c=void 0),angular.isDefined(c)?(f.resolve(c),f.promise):(b.get().$promise.then(function(a){c=a.data,d=!0,f.resolve(c)})["catch"](function(){c=null,d=!1,f.resolve(c)}),f.promise)}}}]),angular.module("treadstoneApp").factory("AuthServerProvider",["$http","localStorageService",function(a,b){var c="xauthtoken";return{login:function(d){return a.post("api/authenticate",d,{headers:{"Content-Type":"application/json",Accept:"application/json"}}).success(function(a){return b.set(c,a),a})},logout:function(){b.clearAll()},getToken:function(){return b.get(c)},hasValidToken:function(){var a=this.getToken(),b=(new Date).getTime()/1e3;return a&&a.expires&&a.expires>b}}}]),angular.module("treadstoneApp").factory("Account",["$resource",function(a){return a("api/account",{},{get:{method:"GET",params:{},isArray:!1,interceptor:{response:function(a){return a}}}})}]),angular.module("treadstoneApp").factory("Activate",["$resource",function(a){return a("api/activate",{},{get:{method:"GET",params:{},isArray:!1}})}]),angular.module("treadstoneApp").factory("Password",["$resource",function(a){return a("api/account/change_password",{},{})}]),angular.module("treadstoneApp").factory("PasswordResetInit",["$resource",function(a){return a("api/account/reset_password/init",{},{})}]),angular.module("treadstoneApp").factory("PasswordResetFinish",["$resource",function(a){return a("api/account/reset_password/finish",{},{})}]),angular.module("treadstoneApp").factory("Register",["$resource",function(a){return a("api/register",{},{})}]),angular.module("treadstoneApp").directive("tsContent",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"scripts/components/content/content.html",scope:{},controller:["$scope","$location","Principal",function(a,b,c){a.expanded=!1,a.isAuthenticated=c.isAuthenticated,a.location=b,a.$watch("location.path()",function(b){a.page=b.substring(1)})}]}}),angular.module("treadstoneApp").factory("Semester",["$resource",function(a){return a("api/semesters/:semester",{},{query:{method:"GET"}})}]).factory("Subject",["$resource",function(a){return a("api/semesters/:semester/subjects/:subject",{},{query:{method:"GET",isArray:!0}})}]).factory("Section",["$resource",function(a){return a("api/semesters/:semester/subjects/:subject/sections/:number",{},{query:{method:"GET",isArray:!0}})}]),angular.module("treadstoneApp").directive("tsEndpoints",function(){return{replace:!0,restrict:"E",templateUrl:"scripts/components/docs/endpoints.html",scope:{resource:"=",endpoints:"="},controller:["$scope",function(a){a.arrow=function(){return a.endpoints.open?"glyphicon-chevron-down":"glyphicon-chevron-left"}}]}}).directive("tsEndpoint",function(){return{replace:!0,restrict:"E",templateUrl:"scripts/components/docs/endpoint.html",scope:{resource:"=",endpoint:"="},controller:["$scope",function(a){var b={GET:"btn-primary",POST:"btn-success",DELETE:"btn-danger"};a.id=(a.endpoint.method+a.endpoint.uri).replace(/\/|:/g,""),a.method=b[a.endpoint.method],a.responseClass=function(a){var b=Math.floor(a.status/100);return 2===b?"list-group-item-success":4===b?"list-group-item-danger":5===b?"list-group-item-warning":void 0}}]}}),angular.module("treadstoneApp").factory("Docs",["$resource",function(a){return a("api/docs",{},{query:{method:"GET",isArray:!1}})}]),angular.module("treadstoneApp").factory("Features",["$resource",function(a){return a("api/features/:id",{},{query:{method:"GET",isArray:!0},get:{method:"GET",transformResponse:function(a){return a=angular.fromJson(a)}}})}]),angular.module("treadstoneApp").directive("tsFooter",function(){return{restrict:"E",replace:!0,templateUrl:"scripts/components/footer/footer.html"}}),angular.module("treadstoneApp").directive("showValidation",function(){return{restrict:"A",require:"form",link:function(a,b){b.find(".form-group").each(function(){var b=$(this),c=b.find("input[ng-model],textarea[ng-model],select[ng-model]");c.length>0&&c.each(function(){var c=$(this);a.$watch(function(){return c.hasClass("ng-invalid")&&c.hasClass("ng-dirty")},function(a){b.toggleClass("has-error",a)})})})}}}),angular.module("treadstoneApp").directive("tsHeader",function(){return{restrict:"E",replace:!0,templateUrl:"scripts/components/header/header.html",scope:{sideMenuExpanded:"=expanded"},controller:["$scope","$window","Auth","Principal",function(a,b,c,d){a.headerExpanded=!1,a.isAuthenticated=d.isAuthenticated,a.logout=function(){c.logout()},a.toggleSideMenu=function(){a.sideMenuExpanded=!a.sideMenuExpanded},a.toggleHeader=function(){a.headerExpanded=!a.headerExpanded},a.window=b,a.$watch("window.document.title",function(b){a.title=b.substring(0,b.indexOf(" |"))})}]}}).directive("tsAffix",["$window",function(a){var b=function(b,c){var d,e="affix affix-top affix-bottom";d=a.pageYOffset<=b?"top":!1,c.removeClass(e).addClass("affix"+(d?"-"+d:""))};return{restrict:"A",link:function(c,d,e){angular.element(a).bind("scroll",function(){b(e.tsAffix,d)})}}}]),angular.module("treadstoneApp").factory("Router",["$rootScope","$location",function(a,b){return{toLanding:function(){b.path("/landing")},toDashboard:function(){b.path("/dashboard")},toAccessDenied:function(){b.path("/accessdenied")},toPrevious:function(){b.path(a.previousRouteName)}}}]),angular.module("treadstoneApp").directive("tsSidemenu",function(){return{restrict:"E",replace:!0,templateUrl:"scripts/components/sidemenu/sidemenu.html",scope:{expanded:"="},controller:["$scope","Principal",function(a,b){a.isAuthenticated=b.isAuthenticated,a.toggleSideMenu=function(){a.expanded=!a.expanded}}]}}).directive("tsActiveLink",["$location",function(a){return{restrict:"A",link:function(b,c,d){var e=d.tsActiveLink;b.location=a,b.$watch("location.path()",function(a){a=a.substring(1),e===a?c.addClass("active"):c.removeClass("active")})}}}]);